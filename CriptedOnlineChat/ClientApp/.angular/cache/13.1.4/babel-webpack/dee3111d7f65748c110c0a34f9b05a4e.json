{"ast":null,"code":"import _asyncToGenerator from \"C:\\\\Users\\\\DELL\\\\source\\\\repos\\\\CriptedOnlineChat\\\\CriptedOnlineChat\\\\ClientApp\\\\node_modules\\\\@babel\\\\runtime\\\\helpers\\\\esm\\\\asyncToGenerator.js\";\nimport * as forge from 'node-forge';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/db\";\nimport * as i2 from \"./WebSocket.service\";\nimport * as i3 from \"./rsa.service\";\nexport class RSAKeysService {\n  constructor(AppDB, WebSocketService, rsaService) {\n    this.rsaService = rsaService;\n    this.appDB = AppDB;\n    this.WebSocketService = WebSocketService;\n  }\n\n  AddPublicKeyToLocalDB(key, isRecipientKey, idKey) {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      let pubKey = {\n        id: idKey,\n        n: key.n,\n        e: key.e\n      };\n\n      if (isRecipientKey) {\n        _this.appDB.PublicKeyForEncript.add(pubKey);\n      } else {\n        _this.appDB.PublicKey.add(pubKey);\n      }\n    })();\n  }\n\n  AddPrivateKeyToLocalDB(privateKey, idKey) {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      let prKey = {\n        id: idKey,\n        n: privateKey.n,\n        e: privateKey.e,\n        d: privateKey.d,\n        p: privateKey.p,\n        q: privateKey.q,\n        dP: privateKey.dP,\n        dQ: privateKey.dQ,\n        qInv: privateKey.qInv\n      };\n      yield _this2.appDB.PrivateKey.add(prKey);\n    })();\n  }\n\n  AddNewRSAKeysServer(keys) {\n    var _this3 = this;\n\n    return _asyncToGenerator(function* () {\n      keys.forEach( /*#__PURE__*/function () {\n        var _ref = _asyncToGenerator(function* (element) {\n          // parsing data\n          let insertedPubKey = {\n            id: uuidv4()\n          }; // parse n data\n\n          let n = new forge.jsbn.BigInteger(null);\n          n.s = element.ns;\n          n.t = element.nt;\n          n.data = JSON.parse(element.nDataJson); // parse e data\n\n          let e = new forge.jsbn.BigInteger(null);\n          e.s = element.es;\n          e.t = element.et;\n          e.data = JSON.parse(element.eDataJson);\n          insertedPubKey.e = e;\n          insertedPubKey.n = n; // add to db\n\n          _this3.appDB.PublicKeyForEncript.add(insertedPubKey);\n\n          let isContaints = (yield _this3.appDB.Contacts.filter(x => x.ContactId == element.senderUserId).count()) == 0;\n\n          if (isContaints) {\n            var keyPair = yield _this3.rsaService.GenerateKeyPair();\n            let pubKeyId = uuidv4();\n            let prtKeyId = uuidv4();\n            yield _this3.AddPublicKeyToLocalDB(keyPair.publicKey, false, pubKeyId);\n            yield _this3.AddPrivateKeyToLocalDB(keyPair.privateKey, prtKeyId);\n            yield _this3.SendRSAPublicKey(element.recipientUserId, element.senderUserId, keyPair.publicKey);\n            let newContact = {\n              Login: element.senderLogin\n            };\n            newContact.ContactId = element.senderUserId;\n            newContact.Login = element.senderLogin;\n            newContact.PublicKeyForEncriptId = insertedPubKey.id;\n            newContact.PrivateKeyId = prtKeyId;\n            newContact.PublicKeyId = pubKeyId;\n\n            _this3.appDB.Contacts.add(newContact);\n          }\n        });\n\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }());\n    })();\n  }\n\n}\n\nRSAKeysService.ɵfac = function RSAKeysService_Factory(t) {\n  return new (t || RSAKeysService)(i0.ɵɵinject(i1.AppDB), i0.ɵɵinject(i2.WebSocketService), i0.ɵɵinject(i3.RSAService));\n};\n\nRSAKeysService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: RSAKeysService,\n  factory: RSAKeysService.ɵfac,\n  providedIn: 'root'\n});\nexport class SendRSAPublicKeyDTO {\n  constructor() {\n    this.senderLogin = \"\";\n    this.senderUserId = \"\";\n    this.recipientUserId = \"\";\n    this.nt = 0;\n    this.ns = 0;\n    this.et = 0;\n    this.es = 0;\n    this.nDataJson = \"\";\n    this.eDataJson = \"\";\n  }\n\n}\n\nSendRSAPublicKeyDTO.ɵfac = function SendRSAPublicKeyDTO_Factory(t) {\n  return new (t || SendRSAPublicKeyDTO)();\n};\n\nSendRSAPublicKeyDTO.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: SendRSAPublicKeyDTO,\n  factory: SendRSAPublicKeyDTO.ɵfac,\n  providedIn: 'root'\n});\n\nfunction uuidv4() {\n  throw new Error('Function not implemented.');\n}","map":{"version":3,"sources":["C:/Users/DELL/source/repos/CriptedOnlineChat/CriptedOnlineChat/ClientApp/src/app/Services/rsa.keys.service.ts"],"names":["forge","i0","i1","i2","i3","RSAKeysService","constructor","AppDB","WebSocketService","rsaService","appDB","AddPublicKeyToLocalDB","key","isRecipientKey","idKey","pubKey","id","n","e","PublicKeyForEncript","add","PublicKey","AddPrivateKeyToLocalDB","privateKey","prKey","d","p","q","dP","dQ","qInv","PrivateKey","AddNewRSAKeysServer","keys","forEach","element","insertedPubKey","uuidv4","jsbn","BigInteger","s","ns","t","nt","data","JSON","parse","nDataJson","es","et","eDataJson","isContaints","Contacts","filter","x","ContactId","senderUserId","count","keyPair","GenerateKeyPair","pubKeyId","prtKeyId","publicKey","SendRSAPublicKey","recipientUserId","newContact","Login","senderLogin","PublicKeyForEncriptId","PrivateKeyId","PublicKeyId","ɵfac","RSAKeysService_Factory","ɵɵinject","RSAService","ɵprov","ɵɵdefineInjectable","token","factory","providedIn","SendRSAPublicKeyDTO","SendRSAPublicKeyDTO_Factory","Error"],"mappings":"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","sourcesContent":["import * as forge from 'node-forge';\r\nimport * as i0 from \"@angular/core\";\r\nimport * as i1 from \"src/db\";\r\nimport * as i2 from \"./WebSocket.service\";\r\nimport * as i3 from \"./rsa.service\";\r\nexport class RSAKeysService {\r\n    constructor(AppDB, WebSocketService, rsaService) {\r\n        this.rsaService = rsaService;\r\n        this.appDB = AppDB;\r\n        this.WebSocketService = WebSocketService;\r\n    }\r\n    async AddPublicKeyToLocalDB(key, isRecipientKey, idKey) {\r\n        let pubKey = { id: idKey, n: key.n, e: key.e };\r\n        if (isRecipientKey) {\r\n            this.appDB.PublicKeyForEncript.add(pubKey);\r\n        }\r\n        else {\r\n            this.appDB.PublicKey.add(pubKey);\r\n        }\r\n    }\r\n    async AddPrivateKeyToLocalDB(privateKey, idKey) {\r\n        let prKey = {\r\n            id: idKey, n: privateKey.n, e: privateKey.e,\r\n            d: privateKey.d, p: privateKey.p, q: privateKey.q,\r\n            dP: privateKey.dP, dQ: privateKey.dQ, qInv: privateKey.qInv\r\n        };\r\n        await this.appDB.PrivateKey.add(prKey);\r\n    }\r\n    async AddNewRSAKeysServer(keys) {\r\n        keys.forEach(async (element) => {\r\n            // parsing data\r\n            let insertedPubKey = { id: uuidv4() };\r\n            // parse n data\r\n            let n = new forge.jsbn.BigInteger(null);\r\n            n.s = element.ns;\r\n            n.t = element.nt;\r\n            n.data = JSON.parse(element.nDataJson);\r\n            // parse e data\r\n            let e = new forge.jsbn.BigInteger(null);\r\n            e.s = element.es;\r\n            e.t = element.et;\r\n            e.data = JSON.parse(element.eDataJson);\r\n            insertedPubKey.e = e;\r\n            insertedPubKey.n = n;\r\n            // add to db\r\n            this.appDB.PublicKeyForEncript.add(insertedPubKey);\r\n            let isContaints = await this.appDB.Contacts.filter(x => x.ContactId == element.senderUserId).count() == 0;\r\n            if (isContaints) {\r\n                var keyPair = await this.rsaService.GenerateKeyPair();\r\n                let pubKeyId = uuidv4();\r\n                let prtKeyId = uuidv4();\r\n                await this.AddPublicKeyToLocalDB(keyPair.publicKey, false, pubKeyId);\r\n                await this.AddPrivateKeyToLocalDB(keyPair.privateKey, prtKeyId);\r\n                await this.SendRSAPublicKey(element.recipientUserId, element.senderUserId, keyPair.publicKey);\r\n                let newContact = { Login: element.senderLogin };\r\n                newContact.ContactId = element.senderUserId;\r\n                newContact.Login = element.senderLogin;\r\n                newContact.PublicKeyForEncriptId = insertedPubKey.id;\r\n                newContact.PrivateKeyId = prtKeyId;\r\n                newContact.PublicKeyId = pubKeyId;\r\n                this.appDB.Contacts.add(newContact);\r\n            }\r\n        });\r\n    }\r\n}\r\nRSAKeysService.ɵfac = function RSAKeysService_Factory(t) { return new (t || RSAKeysService)(i0.ɵɵinject(i1.AppDB), i0.ɵɵinject(i2.WebSocketService), i0.ɵɵinject(i3.RSAService)); };\r\nRSAKeysService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: RSAKeysService, factory: RSAKeysService.ɵfac, providedIn: 'root' });\r\nexport class SendRSAPublicKeyDTO {\r\n    constructor() {\r\n        this.senderLogin = \"\";\r\n        this.senderUserId = \"\";\r\n        this.recipientUserId = \"\";\r\n        this.nt = 0;\r\n        this.ns = 0;\r\n        this.et = 0;\r\n        this.es = 0;\r\n        this.nDataJson = \"\";\r\n        this.eDataJson = \"\";\r\n    }\r\n}\r\nSendRSAPublicKeyDTO.ɵfac = function SendRSAPublicKeyDTO_Factory(t) { return new (t || SendRSAPublicKeyDTO)(); };\r\nSendRSAPublicKeyDTO.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: SendRSAPublicKeyDTO, factory: SendRSAPublicKeyDTO.ɵfac, providedIn: 'root' });\r\nfunction uuidv4() {\r\n    throw new Error('Function not implemented.');\r\n}\r\n"]},"metadata":{},"sourceType":"module"}