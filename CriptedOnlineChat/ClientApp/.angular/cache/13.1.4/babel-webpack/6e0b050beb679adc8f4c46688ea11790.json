{"ast":null,"code":"import _asyncToGenerator from \"C:\\\\Users\\\\DELL\\\\source\\\\repos\\\\CriptedOnlineChat\\\\CriptedOnlineChat\\\\ClientApp\\\\node_modules\\\\@babel\\\\runtime\\\\helpers\\\\esm\\\\asyncToGenerator.js\";\nimport * as signalR from '@microsoft/signalr';\nimport { HubConnectionBuilder } from '@microsoft/signalr';\nimport * as forge from 'node-forge';\nimport { v4 as uuidv4 } from 'uuid';\nimport { environment } from 'src/environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/db\";\nimport * as i2 from \"./message.service\";\nimport * as i3 from \"./rsa.service\";\nimport * as i4 from \"./data.service\";\nexport class WebSocketService {\n  constructor(appDB, messageService, RSAService, dataService) {\n    this.DataService = dataService;\n    this.messageService = messageService;\n    this.appDB = appDB;\n    this.RSAService = RSAService;\n    this.HubConnection = new HubConnectionBuilder().configureLogging(signalR.LogLevel.Debug).withUrl(\"http://\" + environment.basePath + \":\" + environment.basePort + \"/schatHub\", {\n      transport: signalR.HttpTransportType.WebSockets\n    }).build();\n    this.HubConnection.start();\n    this.initWebSocket();\n  }\n\n  initWebSocket() {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      yield _this.HubConnection.on(\"AddNewRSAKeys\", rsaKeys => {\n        _this.AddNewRSAKeysServer(rsaKeys);\n      });\n      yield _this.HubConnection.on(\"AddNewMessages\", messages => {\n        _this.messageService.AddNewMessages(messages);\n      });\n\n      _this.HubConnection.on(\"UpdateData\", data => {\n        _this.HubConnection.send(\"UpdateDataAsync\");\n      });\n    })();\n  }\n\n  sendMessage(message) {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      yield _this2.HubConnection.send(\"SendMessageAsync\", message);\n    })();\n  }\n\n  SendPublicRSAKey(rsaKey) {\n    var _this3 = this;\n\n    return _asyncToGenerator(function* () {\n      yield _this3.HubConnection.send(\"SendRSAKeysAsync\", rsaKey);\n    })();\n  }\n\n  AddPublicKeyToLocalDB(key, isRecipientKey, idKey) {\n    var _this4 = this;\n\n    return _asyncToGenerator(function* () {\n      let pubKey = {\n        id: idKey,\n        n: key.n,\n        e: key.e\n      };\n\n      if (isRecipientKey) {\n        _this4.appDB.PublicKeyForEncript.add(pubKey);\n      } else {\n        _this4.appDB.PublicKey.add(pubKey);\n      }\n    })();\n  }\n\n  AddPrivateKeyToLocalDB(privateKey, idKey) {\n    var _this5 = this;\n\n    return _asyncToGenerator(function* () {\n      let prKey = {\n        id: idKey,\n        n: privateKey.n,\n        e: privateKey.e,\n        d: privateKey.d,\n        p: privateKey.p,\n        q: privateKey.q,\n        dP: privateKey.dP,\n        dQ: privateKey.dQ,\n        qInv: privateKey.qInv\n      };\n      yield _this5.appDB.PrivateKey.add(prKey);\n    })();\n  }\n\n  SendRSAPublicKey(senderid, recipientId, pubKey) {\n    var _this6 = this;\n\n    return _asyncToGenerator(function* () {\n      let sendedRsa = {\n        senderUserId: senderid,\n        recipientUserId: recipientId,\n        nDataJson: JSON.stringify(pubKey.n.data),\n        ns: pubKey.n.s,\n        nt: pubKey.n.t,\n        eDataJson: JSON.stringify(pubKey.e.data),\n        es: pubKey.e.s,\n        et: pubKey.e.t\n      };\n      yield _this6.SendPublicRSAKey(sendedRsa);\n    })();\n  }\n\n  AddNewRSAKeysServer(keys) {\n    var _this7 = this;\n\n    return _asyncToGenerator(function* () {\n      console.log(keys);\n      keys.forEach( /*#__PURE__*/function () {\n        var _ref = _asyncToGenerator(function* (element) {\n          // parsing data\n          let insertedPubKey = {\n            id: uuidv4()\n          }; // parse n data\n\n          let n = new forge.jsbn.BigInteger(null);\n          n.s = element.ns;\n          n.t = element.nt;\n          n.data = JSON.parse(element.nDataJson); // parse e data\n\n          let e = new forge.jsbn.BigInteger(null);\n          e.s = element.es;\n          e.t = element.et;\n          e.data = JSON.parse(element.eDataJson);\n          insertedPubKey.e = e;\n          insertedPubKey.n = n; // add to db\n\n          _this7.appDB.PublicKeyForEncript.add(insertedPubKey);\n\n          let isContaints = (yield _this7.appDB.Contacts.filter(x => x.ContactId == element.senderUserId).count()) == 0;\n\n          if (isContaints) {\n            var keyPair = yield _this7.RSAService.GenerateKeyPair();\n            let pubKeyId = uuidv4();\n            let prtKeyId = uuidv4();\n            yield _this7.AddPublicKeyToLocalDB(keyPair.publicKey, false, pubKeyId);\n            yield _this7.AddPrivateKeyToLocalDB(keyPair.privateKey, prtKeyId);\n            yield _this7.SendRSAPublicKey(element.recipientUserId, element.senderUserId, keyPair.publicKey);\n            let newContact = {\n              Login: element.senderLogin\n            };\n            newContact.ContactId = element.senderUserId;\n            newContact.Login = element.senderLogin;\n            newContact.PublicKeyForEncriptId = insertedPubKey.id;\n            newContact.PrivateKeyId = prtKeyId;\n            newContact.PublicKeyId = pubKeyId;\n\n            _this7.appDB.Contacts.add(newContact);\n\n            _this7.DataService.updateContactList.next();\n          } else {\n            var contact = yield _this7.appDB.Contacts.filter(x => x.ContactId == element.senderUserId).first();\n            yield _this7.appDB.Contacts.update(contact, {\n              \"PublicKeyForEncriptId\": insertedPubKey.id\n            });\n          }\n        });\n\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }());\n    })();\n  }\n\n}\n\nWebSocketService.ɵfac = function WebSocketService_Factory(t) {\n  return new (t || WebSocketService)(i0.ɵɵinject(i1.AppDB), i0.ɵɵinject(i2.MessageService), i0.ɵɵinject(i3.RSAService), i0.ɵɵinject(i4.DataService));\n};\n\nWebSocketService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: WebSocketService,\n  factory: WebSocketService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"sources":["C:/Users/DELL/source/repos/CriptedOnlineChat/CriptedOnlineChat/ClientApp/src/app/Services/websocket.service.ts"],"names":["signalR","HubConnectionBuilder","forge","v4","uuidv4","environment","i0","i1","i2","i3","i4","WebSocketService","constructor","appDB","messageService","RSAService","dataService","DataService","HubConnection","configureLogging","LogLevel","Debug","withUrl","basePath","basePort","transport","HttpTransportType","WebSockets","build","start","initWebSocket","on","rsaKeys","AddNewRSAKeysServer","messages","AddNewMessages","data","send","sendMessage","message","SendPublicRSAKey","rsaKey","AddPublicKeyToLocalDB","key","isRecipientKey","idKey","pubKey","id","n","e","PublicKeyForEncript","add","PublicKey","AddPrivateKeyToLocalDB","privateKey","prKey","d","p","q","dP","dQ","qInv","PrivateKey","SendRSAPublicKey","senderid","recipientId","sendedRsa","senderUserId","recipientUserId","nDataJson","JSON","stringify","ns","s","nt","t","eDataJson","es","et","keys","console","log","forEach","element","insertedPubKey","jsbn","BigInteger","parse","isContaints","Contacts","filter","x","ContactId","count","keyPair","GenerateKeyPair","pubKeyId","prtKeyId","publicKey","newContact","Login","senderLogin","PublicKeyForEncriptId","PrivateKeyId","PublicKeyId","updateContactList","next","contact","first","update","ɵfac","WebSocketService_Factory","ɵɵinject","AppDB","MessageService","ɵprov","ɵɵdefineInjectable","token","factory","providedIn"],"mappings":"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","sourcesContent":["import * as signalR from '@microsoft/signalr';\r\nimport { HubConnectionBuilder } from '@microsoft/signalr';\r\nimport * as forge from 'node-forge';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { environment } from 'src/environments/environment';\r\nimport * as i0 from \"@angular/core\";\r\nimport * as i1 from \"src/db\";\r\nimport * as i2 from \"./message.service\";\r\nimport * as i3 from \"./rsa.service\";\r\nimport * as i4 from \"./data.service\";\r\nexport class WebSocketService {\r\n    constructor(appDB, messageService, RSAService, dataService) {\r\n        this.DataService = dataService;\r\n        this.messageService = messageService;\r\n        this.appDB = appDB;\r\n        this.RSAService = RSAService;\r\n        this.HubConnection = new HubConnectionBuilder()\r\n            .configureLogging(signalR.LogLevel.Debug)\r\n            .withUrl(\"http://\" + environment.basePath + \":\" + environment.basePort + \"/schatHub\", {\r\n            transport: signalR.HttpTransportType.WebSockets\r\n        })\r\n            .build();\r\n        this.HubConnection.start();\r\n        this.initWebSocket();\r\n    }\r\n    async initWebSocket() {\r\n        await this.HubConnection.on(\"AddNewRSAKeys\", rsaKeys => { this.AddNewRSAKeysServer(rsaKeys); });\r\n        await this.HubConnection.on(\"AddNewMessages\", messages => { this.messageService.AddNewMessages(messages); });\r\n        this.HubConnection.on(\"UpdateData\", data => { this.HubConnection.send(\"UpdateDataAsync\"); });\r\n    }\r\n    async sendMessage(message) {\r\n        await this.HubConnection.send(\"SendMessageAsync\", message);\r\n    }\r\n    async SendPublicRSAKey(rsaKey) {\r\n        await this.HubConnection.send(\"SendRSAKeysAsync\", rsaKey);\r\n    }\r\n    async AddPublicKeyToLocalDB(key, isRecipientKey, idKey) {\r\n        let pubKey = { id: idKey, n: key.n, e: key.e };\r\n        if (isRecipientKey) {\r\n            this.appDB.PublicKeyForEncript.add(pubKey);\r\n        }\r\n        else {\r\n            this.appDB.PublicKey.add(pubKey);\r\n        }\r\n    }\r\n    async AddPrivateKeyToLocalDB(privateKey, idKey) {\r\n        let prKey = {\r\n            id: idKey, n: privateKey.n, e: privateKey.e,\r\n            d: privateKey.d, p: privateKey.p, q: privateKey.q,\r\n            dP: privateKey.dP, dQ: privateKey.dQ, qInv: privateKey.qInv\r\n        };\r\n        await this.appDB.PrivateKey.add(prKey);\r\n    }\r\n    async SendRSAPublicKey(senderid, recipientId, pubKey) {\r\n        let sendedRsa = {\r\n            senderUserId: senderid,\r\n            recipientUserId: recipientId, nDataJson: JSON.stringify(pubKey.n.data),\r\n            ns: pubKey.n.s, nt: pubKey.n.t, eDataJson: JSON.stringify(pubKey.e.data), es: pubKey.e.s, et: pubKey.e.t\r\n        };\r\n        await this.SendPublicRSAKey(sendedRsa);\r\n    }\r\n    async AddNewRSAKeysServer(keys) {\r\n        console.log(keys);\r\n        keys.forEach(async (element) => {\r\n            // parsing data\r\n            let insertedPubKey = { id: uuidv4() };\r\n            // parse n data\r\n            let n = new forge.jsbn.BigInteger(null);\r\n            n.s = element.ns;\r\n            n.t = element.nt;\r\n            n.data = JSON.parse(element.nDataJson);\r\n            // parse e data\r\n            let e = new forge.jsbn.BigInteger(null);\r\n            e.s = element.es;\r\n            e.t = element.et;\r\n            e.data = JSON.parse(element.eDataJson);\r\n            insertedPubKey.e = e;\r\n            insertedPubKey.n = n;\r\n            // add to db\r\n            this.appDB.PublicKeyForEncript.add(insertedPubKey);\r\n            let isContaints = await this.appDB.Contacts.filter(x => x.ContactId == element.senderUserId).count() == 0;\r\n            if (isContaints) {\r\n                var keyPair = await this.RSAService.GenerateKeyPair();\r\n                let pubKeyId = uuidv4();\r\n                let prtKeyId = uuidv4();\r\n                await this.AddPublicKeyToLocalDB(keyPair.publicKey, false, pubKeyId);\r\n                await this.AddPrivateKeyToLocalDB(keyPair.privateKey, prtKeyId);\r\n                await this.SendRSAPublicKey(element.recipientUserId, element.senderUserId, keyPair.publicKey);\r\n                let newContact = { Login: element.senderLogin };\r\n                newContact.ContactId = element.senderUserId;\r\n                newContact.Login = element.senderLogin;\r\n                newContact.PublicKeyForEncriptId = insertedPubKey.id;\r\n                newContact.PrivateKeyId = prtKeyId;\r\n                newContact.PublicKeyId = pubKeyId;\r\n                this.appDB.Contacts.add(newContact);\r\n                this.DataService.updateContactList.next();\r\n            }\r\n            else {\r\n                var contact = await this.appDB.Contacts.filter(x => x.ContactId == element.senderUserId).first();\r\n                await this.appDB.Contacts.update(contact, { \"PublicKeyForEncriptId\": insertedPubKey.id });\r\n            }\r\n        });\r\n    }\r\n}\r\nWebSocketService.ɵfac = function WebSocketService_Factory(t) { return new (t || WebSocketService)(i0.ɵɵinject(i1.AppDB), i0.ɵɵinject(i2.MessageService), i0.ɵɵinject(i3.RSAService), i0.ɵɵinject(i4.DataService)); };\r\nWebSocketService.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: WebSocketService, factory: WebSocketService.ɵfac, providedIn: 'root' });\r\n"]},"metadata":{},"sourceType":"module"}